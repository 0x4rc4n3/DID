<!-- frontend/index.html - Landing/Login Page -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecureAccount - Login</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Top Navigation -->
    <nav class="top-nav">
        <div class="nav-container">
            <div class="nav-brand">
                <span class="brand-icon">üõ°Ô∏è</span>
                <span class="brand-text">SecureAccount</span>
            </div>
            <div class="nav-menu">
                <a href="index.html" class="nav-item active">Login</a>
                <a href="create.html" class="nav-item">Create Account</a>
                <a href="search.html" class="nav-item">Search</a>
                <a href="status.html" class="nav-item">System Status</a>
                <a href="guide.html" class="nav-item">Guide</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- Hero Section -->
        <div class="hero-section">
            <h1>üõ°Ô∏è Secure Account Management</h1>
            <p class="hero-subtitle">Your quantum-safe digital identity system</p>
            <p class="hero-description">Login to your secure account or create a new one with post-quantum cryptography protection.</p>
            
            <div class="hero-actions">
                <button onclick="scrollToLogin()" class="btn-primary large">üîë Login Below</button>
                <a href="create.html" class="btn-secondary large">‚ûï Create New Account</a>
            </div>
        </div>

        <!-- Login Page -->
        <div class="page">
            <div class="page-header">
                <h1>üîë Login to Your Account</h1>
                <p>Enter your credentials to access your secure account</p>
            </div>
            
            <div class="form-card">
                <div id="login-form-section">
                    <div class="form-group">
                        <label for="login-account-id">Account ID:</label>
                        <input type="text" id="login-account-id" placeholder="Enter your account ID">
                    </div>
                    <div class="form-group">
                        <label for="login-secret-key">Secret Key:</label>
                        <textarea id="login-secret-key" placeholder="Enter your secret key" rows="3"></textarea>
                        <small>This is the key you saved when creating your account</small>
                    </div>
                    <button onclick="startLogin()" class="btn-primary" id="login-btn">
                        <span class="btn-text">üîë Login</span>
                        <span class="btn-loading hidden">‚è≥ Processing...</span>
                    </button>
                </div>

                <!-- Login Progress -->
                <div id="login-progress" class="progress-section hidden">
                    <h3>üîÑ Authenticating...</h3>
                    <div class="progress-steps">
                        <div class="progress-step" id="step-verify">
                            <div class="step-icon">‚è≥</div>
                            <div class="step-text">Verifying account...</div>
                        </div>
                        <div class="progress-step" id="step-challenge">
                            <div class="step-icon">‚è≥</div>
                            <div class="step-text">Creating security challenge...</div>
                        </div>
                        <div class="progress-step" id="step-sign">
                            <div class="step-icon">‚è≥</div>
                            <div class="step-text">Signing challenge...</div>
                        </div>
                        <div class="progress-step" id="step-authenticate">
                            <div class="step-icon">‚è≥</div>
                            <div class="step-text">Authenticating...</div>
                        </div>
                    </div>
                </div>

                <!-- Login Success -->
                <div id="login-success" class="result-section success-box hidden">
                    <div class="result-icon">üéâ</div>
                    <h3>Login Successful!</h3>
                    <p>You have been successfully authenticated with your account.</p>
                    <div class="account-summary">
                        <div class="summary-row">
                            <strong>Account ID:</strong> <span id="login-success-id"></span>
                        </div>
                    </div>
                    <button onclick="resetLogin()" class="btn-secondary">üîë Login Again</button>
                </div>
                
                <!-- Login Failed -->
                <div id="login-failed" class="result-section error-box hidden">
                    <div class="result-icon">‚ùå</div>
                    <h3>Login Failed</h3>
                    <p>The account credentials could not be verified. Please check your Account ID and Secret Key.</p>
                    <button onclick="resetLogin()" class="btn-secondary">üîÑ Try Again</button>
                </div>
            </div>
        </div>

        <!-- Quick Links -->
        <div class="quick-links">
            <h3>Quick Actions</h3>
            <div class="links-grid">
                <a href="create.html" class="link-card">
                    <div class="link-icon">‚ûï</div>
                    <h4>Create Account</h4>
                    <p>Register a new secure account</p>
                </a>
                <a href="search.html" class="link-card">
                    <div class="link-icon">üîç</div>
                    <h4>Search Account</h4>
                    <p>Look up account information</p>
                </a>
                <a href="guide.html" class="link-card">
                    <div class="link-icon">üìñ</div>
                    <h4>How to Use</h4>
                    <p>Complete user guide</p>
                </a>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5000/api';
        
        // Scroll to login section
        function scrollToLogin() {
            document.querySelector('.page-header').scrollIntoView({ behavior: 'smooth' });
        }
        
        // Simple utility functions
        function setButtonLoading(buttonId, isLoading) {
            const button = document.getElementById(buttonId);
            if (button) {
                if (isLoading) {
                    button.classList.add('loading');
                    button.disabled = true;
                } else {
                    button.classList.remove('loading');
                    button.disabled = false;
                }
            }
        }

        function updateProgressStep(stepId, status) {
            const step = document.getElementById(stepId);
            if (step) {
                step.className = `progress-step ${status}`;
                const icon = step.querySelector('.step-icon');
                if (status === 'completed') {
                    icon.textContent = '‚úÖ';
                } else if (status === 'active') {
                    icon.textContent = '‚è≥';
                } else {
                    icon.textContent = '‚è≥';
                }
            }
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function resetLogin() {
            // Show form, hide results
            document.getElementById('login-form-section').style.display = 'block';
            document.getElementById('login-progress').classList.add('hidden');
            document.getElementById('login-success').classList.add('hidden');
            document.getElementById('login-failed').classList.add('hidden');
            
            // Reset progress steps
            ['step-verify', 'step-challenge', 'step-sign', 'step-authenticate'].forEach(stepId => {
                const step = document.getElementById(stepId);
                if (step) {
                    step.className = 'progress-step';
                    step.querySelector('.step-icon').textContent = '‚è≥';
                }
            });
            
            // Clear form
            document.getElementById('login-account-id').value = '';
            document.getElementById('login-secret-key').value = '';
        }

        async function startLogin() {
            const accountId = document.getElementById('login-account-id').value.trim();
            const secretKey = document.getElementById('login-secret-key').value.trim();
            
            if (!accountId || !secretKey) {
                alert('Please enter both Account ID and Secret Key');
                return;
            }
            
            // Hide form and show progress
            document.getElementById('login-form-section').style.display = 'none';
            document.getElementById('login-progress').classList.remove('hidden');
            document.getElementById('login-success').classList.add('hidden');
            document.getElementById('login-failed').classList.add('hidden');
            
            try {
                // Step 1: Verify account exists
                updateProgressStep('step-verify', 'active');
                const verifyResponse = await fetch(`${API_BASE}/get_did/${encodeURIComponent(accountId)}`);
                const verifyData = await verifyResponse.json();
                
                if (!verifyData.success) {
                    throw new Error('Account not found');
                }
                
                updateProgressStep('step-verify', 'completed');
                await sleep(800);
                
                // Step 2: Create challenge
                updateProgressStep('step-challenge', 'active');
                const challengeResponse = await fetch(`${API_BASE}/create_challenge`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ did: accountId })
                });
                
                const challengeData = await challengeResponse.json();
                if (!challengeData.success) {
                    throw new Error('Failed to create security challenge');
                }
                
                updateProgressStep('step-challenge', 'completed');
                await sleep(800);
                
                // Step 3: Sign challenge
                updateProgressStep('step-sign', 'active');
                const signResponse = await fetch(`${API_BASE}/sign_challenge`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        challenge: challengeData.challenge,
                        private_key: secretKey
                    })
                });
                
                const signData = await signResponse.json();
                if (!signData.success) {
                    throw new Error('Failed to sign challenge - check your Secret Key');
                }
                
                updateProgressStep('step-sign', 'completed');
                await sleep(800);
                
                // Step 4: Authenticate
                updateProgressStep('step-authenticate', 'active');
                const authResponse = await fetch(`${API_BASE}/authenticate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        challenge_id: challengeData.challenge_id,
                        signature: signData.signature
                    })
                });
                
                const authData = await authResponse.json();
                if (!authData.success) {
                    throw new Error('Authentication verification failed');
                }
                
                updateProgressStep('step-authenticate', 'completed');
                await sleep(800);
                
                // Hide progress and show result
                document.getElementById('login-progress').classList.add('hidden');
                
                if (authData.authenticated) {
                    document.getElementById('login-success').classList.remove('hidden');
                    document.getElementById('login-success-id').textContent = accountId;
                } else {
                    document.getElementById('login-failed').classList.remove('hidden');
                }
                
            } catch (error) {
                // Hide progress and show error
                document.getElementById('login-progress').classList.add('hidden');
                document.getElementById('login-failed').classList.remove('hidden');
                console.error('Login failed:', error.message);
            }
        }

        // Auto-fill from URL parameters or localStorage
        window.onload = function() {
            // First try URL parameters (from create page redirect)
            const params = new URLSearchParams(window.location.search);
            let accountId = params.get('account_id');
            let secretKey = params.get('secret_key');
            
            // If no URL params, try localStorage
            if (!accountId || !secretKey) {
                try {
                    accountId = localStorage.getItem('last_account_id');
                    secretKey = localStorage.getItem('last_secret_key');
                } catch (e) {
                    console.log('Cannot read from localStorage:', e);
                }
            }
            
            if (accountId) {
                document.getElementById('login-account-id').value = accountId;
            }
            if (secretKey) {
                document.getElementById('login-secret-key').value = secretKey;
            }
        }
    </script>
</body>
</html>